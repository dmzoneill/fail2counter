#!/bin/bash
# Refresh the Metasploit exploit module list
# This only extracts module paths (fast), not full options (slow)

EXPLOIT_FILE="/opt/fail2counter/exploits.txt"
BACKUP_FILE="${EXPLOIT_FILE}.bak"

echo "[*] Refreshing Metasploit exploit list..."

# Backup current list
if [ -f "$EXPLOIT_FILE" ]; then
    cp "$EXPLOIT_FILE" "$BACKUP_FILE"
fi

# Extract all exploit module paths
/opt/metasploit-framework/bin/msfconsole -q -x "show exploits; exit" 2>/dev/null \
    | grep 'exploit/' \
    | awk '{print $2}' \
    | sort -u > "${EXPLOIT_FILE}.new"

# Only replace if we got results
NEW_COUNT=$(wc -l < "${EXPLOIT_FILE}.new")
if [ "$NEW_COUNT" -gt 100 ]; then
    mv "${EXPLOIT_FILE}.new" "$EXPLOIT_FILE"
    echo "[*] Updated exploit list: ${NEW_COUNT} modules"
else
    echo "[!] Refresh produced too few results (${NEW_COUNT}), keeping existing list"
    rm -f "${EXPLOIT_FILE}.new"
fi
